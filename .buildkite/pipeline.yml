---
env:
  ANKA_IMAGE_NAME: high-sierra
  ANKA_IMAGE_TAG: fresh
steps:
  # Executing commands without the anka plugin enabled WILL EXECUTE ON THE HOST MACHINES AND COULD RUIN THEM. Please be sure to test the anka plugin is functional and executes all commands with 'anka run $COMMAND'
  - label: ":darwin: High Sierra Build"
    command:
      - "./scripts/eosio_build.sh -y && tar -pczf build.tar.gz build"
    artifact_paths: "build.tar.gz"
    plugins:
      chef/anka#v0.1.1:
        vm-name: $ANKA_IMAGE_NAME
        vm-registry-tag: $ANKA_IMAGE_TAG
        always-pull: true
        inherit-environment-vars: false
        debug: true
    agents:
      - "role=anka-tester"
    timeout: 60
    retry:
      automatic:
        # Agent was lost
        - exit_status: -1
          limit: 2
        # Forced agent shutdown
        - exit_status: 255
          limit: 2

  - wait

  - label: ":darwin: High Sierra Tests"
    command:
      - "buildkite-agent artifact download \"build.tar.gz\" . --step \":darwin: High Sierra Build\""
      - "tar -zxf build.tar.gz"
      - "~/bin/mongod --fork --dbpath ~/data/mongodb -f ~/etc/mongod.conf --logpath ./mongod.log"
      - "cd build && PATH=$PATH:~/opt/mongodb/bin ctest -j8 -LE _tests --output-on-failure"
    artifact_paths:
      - "mongod.log"
      - "build/genesis.json"
      - "build/config.ini"
    agents:
      - "role=anka-tester"
    plugins:
      chef/anka#v0.1.1:
        vm-name: $ANKA_IMAGE_NAME
        vm-registry-tag: $ANKA_IMAGE_TAG
        always-pull: true
        inherit-environment-vars: false
        debug: true
    timeout: 60
    retry:
      automatic:
        # Agent was lost
        - exit_status: -1
          limit: 2
        # Forced agent shutdown
        - exit_status: 255
          limit: 2

  - label: ":darwin: High Sierra NP Tests"
    command:
      - "buildkite-agent artifact download \"build.tar.gz\" . --step \":darwin: High Sierra Build\""
      - "tar -zxf build.tar.gz"
      - "~/bin/mongod --fork --dbpath ~/data/mongodb -f ~/etc/mongod.conf --logpath ./mongod.log"
      - "cd build && PATH=$PATH:~/opt/mongodb/bin ctest -L nonparallelizable_tests --output-on-failure"
    artifact_paths:
      - "mongod.log"
      - "build/genesis.json"
      - "build/config.ini"
    agents:
      - "role=anka-tester"
    plugins:
      chef/anka#v0.1.1:
        vm-name: $ANKA_IMAGE_NAME
        vm-registry-tag: $ANKA_IMAGE_TAG
        always-pull: true
        inherit-environment-vars: false
        debug: true
    timeout: 60
    retry:
      automatic:
        # Agent was lost
        - exit_status: -1
          limit: 2
        # Forced agent shutdown
        - exit_status: 255
          limit: 2
